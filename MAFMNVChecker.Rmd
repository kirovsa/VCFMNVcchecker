---
title: "MAFMNVChecker"
author: "Stefan Kirov"
date: "August 20, 2020"
output: html_document
params: 
  MAF:
    label: "Input file: "
    value: "CBIO.MAF"
    input: file
---

```{r setup, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(shiny.maxRequestSize=5*1024^3)
options(rsconnect.max.bundle.size = 5*1024^3)
library(ggplot2)
library(reshape)
library(Biostrings)
library(kableExtra)
```

```{r MNVfunctions, echo=FALSE}


combineMNVs<-function(rowsMNV) {
  #Assume 2 only for now
  #If these are the same substitutions they may be merged or otherwise ineligible
  if (rowsMNV[1,45]==rowsMNV[2,45]) {
    return(NULL)
  }
  rowData<-c(rowsMNV[1,c(1,2,3,4,5,6,40,41,45,50)],rowsMNV[2,c(40,41,45,50)])
  names(rowData)<-c("UID","Gene","Sample","Transcript","Position","Count","MutReads1","RefReads1","Mutation1","Codon1","MutReads2","RefReads2","Mutation2","Codon2")
  return(unlist(rowData))
}

getMNVs<-function(uidlist,allcodons.mnv) {
  mnv.data<-lapply(uidlist, function(x) combineMNVs(allcodons.mnv[allcodons.mnv$UID==x,]))
  return(Filter(Negate(is.null), mnv.data))
}

combineCodons<-function (codon) {
  icodons<-strsplit(codon[[10]],"/")
  ivec1<-strsplit(icodons[[1]][2],"")
  icodons<-strsplit(codon[[14]],"/")
  ivec2<-strsplit(icodons[[1]][2],"")
  
  finalvec<-vector()
  for (i in 1:3) {
    if  (ivec1[[1]][i]==toupper(ivec1[[1]][i])) {
      finalvec[i]<-ivec1[[1]][i]
    }
    else {
       finalvec[i]<-ivec2[[1]][i]
    }
  }
newcodon<-toupper(paste0(finalvec, collapse = ''))
return(c(newcodon,GENETIC_CODE[[newcodon]]))
}

determineConsequences<-function(conseq) {
  mut1v<-strsplit(conseq[[9]],"\\d+")
  mut2v<-strsplit(conseq[[13]],"\\d+")
  fmut<-conseq[[19]]
  mut1<-mut1v[[1]][2]
  mut2<-mut2v[[1]][2]
  orimut<-mut1v[[1]][1] 
  orimut<-gsub("p\\.","",orimut)
  
  if (mut1=="Ter") mut1="*"
  if (mut2=="Ter") mut2="*"
  if (mut1==fmut | mut1==fmut) {
   return("Same as one independent SNV")
  }
  if (fmut==orimut) {
    return("Reversal of mutation")
  }
  if (mut1=='*' | mut2=='*' | fmut == '*') {
    return("Change in stop codon")
  }
  return("Novel amino acid")
}

```

```{r analyzeMAF}

mafD<-read.table(params$MAF,sep="\t",head=T,quote = "",colClasses = "character")
print(dim(mafD))
mafD<-mafD[mafD$Consequence=="synonymous_variant"|mafD$Consequence=="missense_variant"|mafD$Consequence=="stop_gained"|mafD$Consequence=="stop_lost",]
mafD<-mafD[grep("^IG[HKL]",mafD$Hugo_Symbol,invert=T),]
mafD<-mafD[grep("^HLA",mafD$Hugo_Symbol,invert=T),]
print(dim(mafD))
  allcodons.stats<-aggregate(HGVSp ~ Hugo_Symbol + Tumor_Sample_Barcode + Transcript_ID + Protein_position,data=mafD,length)
allcodons.stats<-allcodons.stats[allcodons.stats$HGVSp>1,]
topsamples<-head(allcodons.stats$Tumor_Sample_Barcode,n=50)
allcodons.stats<-allcodons.stats[allcodons.stats$Tumor_Sample_Barcode %in% topsamples,]
print(dim(allcodons.stats))

allcodons.stats$UID<-paste0(allcodons.stats$Hugo_Symbol,allcodons.stats$Tumor_Sample_Barcode, allcodons.stats$Transcript_ID,allcodons.stats$Protein_position,sep=".")
mafD$UID<-paste0(mafD$Hugo_Symbol,mafD$Tumor_Sample_Barcode, mafD$Transcript_ID,mafD$Protein_position,sep=".")

allcodons.mnv<-merge(allcodons.stats,mafD,by="UID")
print("Done with putative MNV identification")

mnv<-getMNVs(unique(as.character(allcodons.mnv$UID)),allcodons.mnv)
mnv.df<-as.data.frame(do.call(rbind, mnv))
#Calculate frequencies, new MNV codon
mnv.df$MutReads1<-as.numeric(mnv.df$MutReads1)
mnv.df$MutReads2<-as.numeric(mnv.df$MutReads2)
mnv.df$RefReads1<-as.numeric(mnv.df$RefReads1)
mnv.df$RefReads2<-as.numeric(mnv.df$RefReads2)
mnv.df$Freq1<-mnv.df$MutReads1/(mnv.df$MutReads1+mnv.df$RefReads1)
mnv.df$Freq2<-mnv.df$MutReads2/(mnv.df$MutReads2+mnv.df$RefReads2)
mnv.df$MinAltCov<-with(mnv.df, pmin(mnv.df$MutReads1,mnv.df$MutReads2))
#Min 3 alt reads
mnv.df<-mnv.df[mnv.df$MinAltCov>2,]
pcor<-round(cor(mnv.df$Freq1,mnv.df$Freq2),2)
scor<-round(cor(mnv.df$Freq1,mnv.df$Freq2,method="spearman"),2)

sample.corp<-unlist(lapply(unique(mnv.df$Sample),function(x)cor(mnv.df[mnv.df$Sample==x,"Freq1"],mnv.df[mnv.df$Sample==x,"Freq2"])))

sample.cors<-unlist(lapply(unique(mnv.df$Sample),function(x)cor(mnv.df[mnv.df$Sample==x,"Freq1"],mnv.df[mnv.df$Sample==x,"Freq2"],method="spearman")))

sample.cor<-data.frame("Pearson"=sample.corp, "Spearman"=sample.cors)
sample.cor$Sample<-as.character(unlist(unique(mnv.df$Sample)))
sample.draw<-melt(sample.cor,id=c("Sample"))
colnames(sample.draw)<-c("Sample","Type","Correlation")

save(mnv.df,file="mnv.Rdat")


```


```{r MNV correction}

newcodons<-apply(mnv.df,1,combineCodons)
mnv.df$newCodon<-newcodons[1,]
mnv.df$newAA<-newcodons[2,]
consequences<-apply(mnv.df,1,determineConsequences)
mnv.df$MNVConsquence<-consequences
#Write
fname<-paste0(params$MAF,".MNV")
write.table(mnv.df,file=fname,sep="\t",quote=F,row.names = F)

```


Plots describing the cohort

```{r correlationPlot, echo=FALSE}

#Overall correlation

ggplot(mnv.df,aes(x=Freq1,y=Freq2,col=log2(MinAltCov)))+geom_point()+ 
      ggtitle(paste("Same codon SNVs for all samples")) +
      annotate(geom="text", x=0.2, y=0.6, label=paste("Spearman",scor),color="red") +
      annotate(geom="text", x=0.2, y=0.63, label=paste("Pearson",pcor),color="red") +
      scale_x_continuous(expand = c(0, 0)) + scale_y_continuous(expand = c(0, 0))

ggplot(sample.draw,aes(x=Sample,y=Correlation, fill=Type))+geom_bar(position="dodge",stat="identity")+ theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

print("Summary of changes")
summary(as.factor(mnv.df$MNVConsquence))
sample.changes<-aggregate(UID ~ Sample+MNVConsquence,data=mnv.df,length)
colnames(sample.changes)<-c("Sample","MNVConsequence","Count")
kable(sample.changes) 

#Correlations coefficients per sample

```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
